# Test for Python minimum version policy
test_python_version_policy:
  # Test with valid Python versions - should pass
  input:
    version: 2.1
    jobs:
      build:
        docker:
          - image: cimg/python:3.13.5
      test:
        docker:
          - image: cimg/python:3.14.0
    _compiled_:
      jobs:
        build:
          docker:
            - image: cimg/python:3.13.5
        test:
          docker:
            - image: cimg/python:3.14.0
  decision: &root_decision
    status: PASS
    enabled_rules: [python_minimum_version]
  
  cases:
    # Test with Python version below minimum - should generate soft failures
    python_version_too_low:
      input:
        jobs:
          build:
            docker:
              - image: cimg/python:3.13.4
        _compiled_:
          jobs:
            build:
              docker:
                - image: cimg/python:3.13.4
      decision:
        status: SOFT_FAIL
        enabled_rules: [python_minimum_version]
        soft_failures:
          - rule: python_minimum_version
            reason: "Job 'build' uses Python version 3.13.4 which is below the minimum required version 3.13.5. Please update to cimg/python:3.13.5 or higher. For help, contact the Platform team or see https://github.com/CircleCI-Labs/platform-team-configs/blob/main/policies/python-version/README.md"
    
    # Test with much older Python version
    python_version_very_old:
      input:
        jobs:
          build:
            docker:
              - image: cimg/python:3.12.0
          test:
            docker:
              - image: cimg/python:3.11.5
        _compiled_:
          jobs:
            build:
              docker:
                - image: cimg/python:3.12.0
            test:
              docker:
                - image: cimg/python:3.11.5
      decision:
        status: SOFT_FAIL
        enabled_rules: [python_minimum_version]
        soft_failures:
          - rule: python_minimum_version
            reason: "Job 'build' uses Python version 3.12.0 which is below the minimum required version 3.13.5. Please update to cimg/python:3.13.5 or higher. For help, contact the Platform team or see https://github.com/CircleCI-Labs/platform-team-configs/blob/main/policies/python-version/README.md"
          - rule: python_minimum_version
            reason: "Job 'test' uses Python version 3.11.5 which is below the minimum required version 3.13.5. Please update to cimg/python:3.13.5 or higher. For help, contact the Platform team or see https://github.com/CircleCI-Labs/platform-team-configs/blob/main/policies/python-version/README.md"
    
    # Test with non-Python images - should be ignored
    non_python_images:
      input:
        jobs:
          build:
            docker:
              - image: cimg/node:20.11
          test:
            docker:
              - image: cimg/base:stable
        _compiled_:
          jobs:
            build:
              docker:
                - image: cimg/node:20.11
            test:
              docker:
                - image: cimg/base:stable
      decision:
        <<: *root_decision
        status: PASS
    
    # Test with mixed Python and non-Python images
    mixed_images:
      input:
        jobs:
          python_job:
            docker:
              - image: cimg/python:3.13.4  # Should soft fail
          node_job:
            docker:
              - image: cimg/node:20.11     # Should ignore
          valid_python_job:
            docker:
              - image: cimg/python:3.13.5  # Should pass
        _compiled_:
          jobs:
            python_job:
              docker:
                - image: cimg/python:3.13.4
            node_job:
              docker:
                - image: cimg/node:20.11
            valid_python_job:
              docker:
                - image: cimg/python:3.13.5
      decision:
        status: SOFT_FAIL
        enabled_rules: [python_minimum_version]
        soft_failures:
          - rule: python_minimum_version
            reason: "Job 'python_job' uses Python version 3.13.4 which is below the minimum required version 3.13.5. Please update to cimg/python:3.13.5 or higher. For help, contact the Platform team or see https://github.com/CircleCI-Labs/platform-team-configs/blob/main/policies/python-version/README.md"
    
    # Test with no jobs - should pass
    no_jobs:
      input:
        workflows:
          build:
            jobs: []
      decision:
        <<: *root_decision
        status: PASS
    
    # Test excluded project with old Python version - should pass without warnings
    excluded_project_old_python:
      input:
        meta:
          project_id: "e3914273-2713-4f0f-999d-f9fbd6748cf8"
        jobs:
          build:
            docker:
              - image: cimg/python:3.11.0
        _compiled_:
          jobs:
            build:
              docker:
                - image: cimg/python:3.11.0
      decision:
        <<: *root_decision
        status: PASS 